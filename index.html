<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        .rowClass{
            text-decoration: line-through;
        }
    </style>
</head>
<body>
    <h1>To Do List</h1>
    <div>
        <input type="hidden" id="id">
        <label for="txt">Text:</label>
        <br>
        <textarea id="txt" maxlength="50"></textarea>
        <button onclick="addOrEdit()">Send</button>
    </div>
    <hr>
    <input id="search" placeholder="Search..." oninput="sortTable()">
    <table border="1">
        <thead>
            <tr>
                <!-- <th>ID</th> -->
                <th></th>
                <th>Text</th>
                <!-- <th>IsDone</th> -->
                <th>Edit</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody id="myTable"></tbody>
        <script>
            let data = [];
            async function getData() {
                let response = await fetch('/t',{
                    method:'GET'
                });
                data = await response.json();
                createTable(data);
            }
            function createTable(data){
                let txt = "";
                for(obj of data){
                    if(obj){
                        let row = obj.isDone ? "rowClass" : "";
                        let check = obj.isDone ? "checked" : "";
                        txt += `<tr class='${row}'>`;
                        // txt += `<td>${obj.id}</td>`;
                        txt += `<td><input type="checkbox" onchange="isChecked(this,${obj.id})" ${check}></td>`;
                        txt += `<td>${obj.text}</td>`;
                        // txt += `<td>${obj.isDone}</td>`;
                        txt += `<td><button onclick="taskById(${obj.id})">‚úèÔ∏è</button></td>`;
                        txt += `<td><button onclick="deleteTask(${obj.id})">üóëÔ∏è</button></td>`;
                        txt += `</tr>`;
                    }                    
                }
                document.getElementById('myTable').innerHTML = txt;
            }
            async function addTask() {
                try{
                    let txt = document.getElementById('txt').value;
                    let response = await fetch('/t',{
                        method: 'POST',
                        headers: {'Content-type':'application/json'},
                        body: JSON.stringify({txt})
                    })
                    // if(response.ok){
                    //     alert("◊†◊ï◊°◊£ ◊ë◊î◊¶◊ú◊ó◊î")
                    // }
                    // if(response.status == 201){
                    //     alert("◊†◊ï◊°◊£ ◊ë◊î◊¶◊ú◊ó◊î")
                    // }
                    getData();
                    document.getElementById('txt').value = "";
                }catch(err){
                    alert(err);
                }

            }
            async function deleteTask(id) {
                try{
                    if(confirm("◊î◊ê◊ù ◊ú◊û◊ó◊ï◊ß")){
                        let response = await fetch(`/t/${id}`,{
                            method: 'DELETE'
                        })
                        getData();
                    }
                }catch(err){
                    alert(err);
                }
            }
            async function taskById(id) {
                try{
                    let response = await fetch(`/t/${id}`);
                    let obj = await response.json();
                    document.getElementById('id').value = obj.id;
                    document.getElementById('txt').value = obj.text;
                }catch(err){
                    alert(err);
                }
            }
            async function editTask(id) {
                try{
                    let txt = document.getElementById('txt').value;
                    let response = await fetch(`/t/${id}`,{
                        method: 'PATCH',
                        headers: {'Content-type':'application/json'},
                        body: JSON.stringify({txt})
                    })
                    getData();
                    document.getElementById('id').value = "";
                    document.getElementById('txt').value = "";
                }catch(err){
                    alert(err);
                }
            }
            async function isChecked(element,id) {
                try{
                    let isDone = element.checked;
                    
                    let response = await fetch(`/t/${id}`,{
                        method: 'PATCH',
                        headers: {'Content-type':'application/json'},
                        body: JSON.stringify({isDone})
                    })
                    // getData();
                }catch(err){
                    alert(err);
                }
                
            }
            function addOrEdit(){
                let id = document.getElementById('id').value;
                if(id){
                    editTask(id);
                }else{
                    addTask();
                }
            }
            function sortTable(){
                let val = document.getElementById('search').value;
                let sorted = data.filter(obj=>obj && obj.text.includes(val))
                if(sorted){
                    createTable(sorted)
                }else{
                    createTable(data)
                }
            }
            getData();
        </script>
    </table>
</body>
</html>